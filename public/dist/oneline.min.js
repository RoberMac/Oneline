angular.module("Oneline",["ngTouch","ngResource","ui.router","angular-jwt","angular-storage","linkify","Oneline.rootControllers","Oneline.settingsControllers","Oneline.timelineControllers","Oneline.timelineServices","Oneline.relativeDateServices","Oneline.tokenHelperServices","Oneline.UIServices","Oneline.olVideoDirectives","Oneline.trimMediaLinkDirectives"]).config(["$locationProvider","$stateProvider","$urlRouterProvider","$httpProvider","jwtInterceptorProvider",function(e,t,i,r,n){e.html5Mode(!0),n.tokenGetter=function(){return localStorage.getItem("tokenList")},r.interceptors.push("jwtInterceptor"),i.otherwise("/"),t.state("settings",{url:"/?s",templateUrl:"/public/dist/settings.min.html",controller:"settingsCtrl"}).state("timeline",{url:"/{provider:all|twitter|instagram|weibo}",templateUrl:"/public/dist/timeline.min.html",controller:"timelineCtrl"})}]).factory("timelineCache",["$cacheFactory",function(e){return e("timelineCache")}]);
angular.module("Oneline.olVideoDirectives",[]).directive("olVideo",function(){return{restrict:"E",scope:{olPoster:"=",olSrc:"="},template:'<video ng-attr-poster="{{olPoster}}" preload="none"></video>                    <svg class="timeline__media__playButton animate--faster">                        <use xlink:href="/public/img/icon-sprite.svg#play-icon"></use>                    </svg>',link:function(e,i,n){var l=i.children()[0],t=angular.element(i.children()[1]);l.setAttribute("src",e.olSrc),i.bind("click",function(){l.paused?l.play():l.pause(),t.toggleClass("timeline__media__playButton--playing")}),angular.element(l).bind("ended",function(){t.removeClass("timeline__media__playButton--playing")})}}});
angular.module("Oneline.trimMediaLinkDirectives",[]).directive("trimMediaLink",["$timeout",function(i){return{restrict:"A",link:function(e,t,n){i(function(){t.html(t.html().replace(n.trimMediaLink,""))})}}}]);
angular.module("Oneline.UIServices",[]).service("olUI",function(){this.setLoading=function(e,a){var l=angular.element(document.getElementsByClassName("loadMore")[1===a?0:1]);e?l.children().addClass("loadMore__loading"):(l.removeClass("loadMore--initLoad"),l.children().removeClass("loadMore__loading"))},this.isLoading=function(e){var a=angular.element(document.getElementsByClassName("loadMore")[1===e?0:1]);return a.children().hasClass("loadMore__loading")},this.setDivider=function(e){var a=document.getElementsByClassName("timeline");1===e?angular.element(a[0]).addClass("divider--top"):angular.element(a[a.length-1]).addClass("divider--bottom")}});
angular.module("Oneline.relativeDateServices",["relativeDate"]).value("relativeDateTranslations",{just_now:"0s",seconds_ago:"{{time}}s",a_minute_ago:"1m",minutes_ago:"{{time}}m",an_hour_ago:"1h",hours_ago:"{{time}}h",a_day_ago:"1d",days_ago:"{{time}}d",a_week_ago:"1w",weeks_ago:"{{time}}w",a_month_ago:"1M",months_ago:"{{time}}M",a_year_ago:"1y",years_ago:"{{time}}y",over_a_year_ago:"> 1y",seconds_from_now:"+ {{time}}s",a_minute_from_now:"+ 1m",minutes_from_now:"+ {{time}}m",an_hour_from_now:"+ 1h",hours_from_now:"+ {{time}}h",a_day_from_now:"+ 1d",days_from_now:"+ {{time}}d",a_week_from_now:"+ 1w",weeks_from_now:"+ {{time}}w",a_month_from_now:"+ 1M",months_from_now:"+ {{time}}M",a_year_from_now:"+ 1y",years_from_now:"+ {{time}}y",over_a_year_from_now:"++ 1y"});
angular.module("Oneline.timelineServices",[]).factory("Timeline",["$resource",function(t){return t("/timeline/:id/:count",null,{initLoad:{method:"GET"},load:{method:"GET"}})}]).service("olTimelineHelper",["$q","Timeline","timelineCache",function(t,e,n){var i=Date.now(),o=30,r=18e5;this.getMaxId=function(t){var e="";return t.forEach(function(n,i){var o=document.getElementsByClassName("timeline--"+n),r=n+"_minId-"+o[0].getAttribute("data-id")+(i===t.length-1?"":",");e+=r}),e},this.getMinId=function(t){var e="";return t.forEach(function(i,o){var r=(n.get("oldPosts"),i+"_maxId-"+n.get(i+"_min_id")+(o===t.length-1?"":","));e+=r}),e},this.storeOldPosts=function(t,e){var i=t.data,o=n.get("oldPosts")||[];e.forEach(function(e){var i=e+"_min_id",o=t.min_id[e],r=e+"_min_date",l=t.min_date[e];o&&n.put(i,o),l&&n.put(r,l)}),o=o.concat(i),n.put("oldPosts",o)},this.checkOldPosts=function(e){return t(function(t,o){var l=e.filter(function(t){return i-n.get(t+"_min_date")<r});l.length>0?t(l):o("all valid")})},this.extractOldPosts=function(){var t=n.get("oldPosts")||[],e=[],o=t.filter(function(t){var n=i-t.created_at<=r;return n||e.push(t),n});return n.put("oldPosts",e),i-=r,o},this.loadOldPosts=function(n,i){function r(n){var r=t.defer(),l=u.getMinId(n),s=o;return e.load({id:l,count:s}).$promise.then(function(t){t.min_date.twitter&&t.data.splice(0,1),u.storeOldPosts(t,i),100>s?s+=10:null,r.resolve()}),r.promise}function l(){var e=t.defer();return u.checkOldPosts(i).then(function(t){r(t).then(l).then(function(){e.resolve()})},function(){e.resolve()}),e.promise}var s=t.defer(),u=this;return r(n).then(l).then(function(){100>o?o+=10:null,s.resolve()}),s.promise}}]);
angular.module("Oneline.tokenHelperServices",[]).service("olTokenHelper",["jwtHelper","store",function(e,n){this.addToken=function(){var t=localStorage.getItem("addToken"),r=e.decodeToken(t).provider,i=n.get("tokenList")||[];i=o.removeToken(i,r),i.push(t),n.set("tokenList",i),n.remove("addToken")},this.removeToken=function(e){var t=n.get("tokenList")||[];t=o.removeToken(t,e),n.set("tokenList",t)},this.clearToken=function(){n.remove("tokenList")},this.getProviderList=function(){var o=n.get("tokenList")||[];return o.map(function(n){return e.decodeToken(n).provider})},this.isValidToken=function(){var o=n.get("tokenList")||[];return o.some(function(n){return!e.isTokenExpired(n)})};var o={removeToken:function(n,o){return n.filter(function(n){return o!==e.decodeToken(n).provider})}}}]);
angular.module("Oneline.rootControllers",[]).controller("rootController",["$scope","$timeout","store","olTokenHelper",function(e,i,r,o){e.providerList=o.getProviderList(),e.isTimeline=!1,e.timelineProvider=r.get("timelineProvider")||"all",r.set("timelineProvider",e.timelineProvider),e.updateProviderList=function(){i(function(){e.providerList=o.getProviderList()})},e.setTimeline=function(i){e.isTimeline=i},e.isAuth=function(i){return e.providerList.indexOf(i)>=0}}]);
angular.module("Oneline.settingsControllers",[]).controller("settingsCtrl",["$scope","$window","$state","$stateParams","store","olTokenHelper",function(e,t,n,o,i,r){r.isValidToken()&&"1"!==o.s?n.go("timeline",{provider:i.get("timelineProvider")}):null,e.setTimeline(!1),t.addEventListener("storage",function(t){"addToken"===t.key&&(r.addToken(),e.updateProviderList())}),e.toggleAuth=function(n){e.providerList.indexOf(n)<0?t.open("/auth/"+n,"_blank"):(r.removeToken(n),e.updateProviderList())}}]);
angular.module("Oneline.timelineControllers",[]).controller("timelineCtrl",["$scope","$state","$stateParams","store","Timeline","olUI","olTokenHelper","olTimelineHelper","timelineCache",function(e,i,t,n,o,l,a,r,s){function d(e){n.set("timelineProvider",e),i.go("timeline",{provider:e})}a.isValidToken()?null:i.go("settings",{settings:"settings"}),e.setTimeline(!0),e.providerList.indexOf(t.provider)>=0||"all"===t.provider?d(t.provider):i.go("timeline",{provider:n.get("timelineProvider")}),e.timelineData=[],o.initLoad().$promise.then(function(i){r.storeOldPosts(i,e.providerList),e.timelineData=r.extractOldPosts(),l.setLoading(!1,1),l.setLoading(!1,-1)}),e.loadMore=function(i){l.isLoading(i)||(l.setLoading(!0,i),i>0?o.load({id:r.getMaxId(e.providerList),count:20}).$promise.then(function(t){t.data.length>0&&(l.setDivider(i),e.timelineData=e.timelineData.concat(t.data))})["catch"](function(e){console.log(e)})["finally"](function(){l.setLoading(!1,i)}):r.checkOldPosts(e.providerList).then(function(i){return r.loadOldPosts(i,e.providerList)},function(){})["catch"](function(e){console.log(e)})["finally"](function(){l.setDivider(i),l.setLoading(!1,i),e.timelineData=e.timelineData.concat(r.extractOldPosts())}))}}]);
//# sourceMappingURL=oneline.min.js.map