angular.module("Oneline",["ngTouch","ngResource","ui.router","angular-jwt","angular-storage","linkify","Oneline.rootControllers","Oneline.settingsControllers","Oneline.timelineControllers","Oneline.timelineServices","Oneline.actionsServices","Oneline.RESTfulServices","Oneline.relativeDateServices","Oneline.tokenHelperServices","Oneline.UIServices","Oneline.olVideoDirectives","Oneline.trimMediaLinkDirectives"]).config(["$locationProvider","$stateProvider","$urlRouterProvider","$httpProvider","jwtInterceptorProvider",function(e,t,i,n,r){e.html5Mode(!0),r.tokenGetter=function(){return localStorage.getItem("tokenList")},n.interceptors.push("jwtInterceptor"),i.otherwise("/"),t.state("settings",{url:"/?s",templateUrl:"/public/dist/settings.min.html",controller:"settingsCtrl"}).state("timeline",{url:"/{provider:all|twitter|instagram|weibo}",templateUrl:"/public/dist/timeline.min.html",controller:"timelineCtrl"})}]).factory("timelineCache",["$cacheFactory",function(e){return e("timelineCache")}]);
angular.module("Oneline.olVideoDirectives",[]).directive("olVideo",function(){return{restrict:"E",scope:{olPoster:"=",olSrc:"="},template:'<video ng-attr-poster="{{olPoster}}" preload="none"></video>                    <svg class="timeline__media__playButton animate--faster">                        <use xlink:href="/public/img/icon-sprite.svg#play-icon"></use>                    </svg>',link:function(e,i,n){var l=i.children()[0],t=angular.element(i.children()[1]);l.setAttribute("src",e.olSrc),i.bind("click",function(){l.paused?l.play():l.pause(),t.toggleClass("timeline__media__playButton--playing")}),angular.element(l).bind("ended",function(){t.removeClass("timeline__media__playButton--playing")})}}});
angular.module("Oneline.trimMediaLinkDirectives",[]).directive("trimMediaLink",["$timeout",function(i){return{restrict:"A",link:function(e,t,n){i(function(){t.html(t.html().replace(n.trimMediaLink,""))})}}}]);
angular.module("Oneline.RESTfulServices",[]).factory("Timeline",["$resource",function(e){return e("/timeline/:id/:count",null,{initLoad:{method:"GET"},load:{method:"GET"}})}]).factory("Action",["$resource",function(e){return e("/actions/:action/:provider/:id",null,{create:{method:"PUT",params:{action:"@action",provider:"@provider",id:"@id"}},destroy:{method:"DELETE"}})}]).factory("Auth",["$resource",function(e){return e("/auth/revoke/:provider",null,{revoke:{method:"DELETE"}})}]);
angular.module("Oneline.UIServices",[]).service("olUI",function(){this.setLoading=function(e,t){var a=angular.element(document.getElementsByClassName("loadMore")[1===t?0:1]);e?a.children().addClass("loadMore__loading"):(a.removeClass("loadMore--initLoad"),a.children().removeClass("loadMore__loading"))},this.isLoading=function(e){var t=angular.element(document.getElementsByClassName("loadMore")[1===e?0:1]);return t.children().hasClass("loadMore__loading")},this.setDivider=function(e){var t=document.getElementsByClassName("timeline");1===e?angular.element(t[0]).addClass("divider--top"):angular.element(t[t.length-1]).addClass("divider--bottom")},this.setNewPostsCount=function(e){document.getElementsByClassName("loadMore__count")[0].setAttribute("data-count",e)},this.setActionState=function(e,t,a){var n=angular.element(document.querySelector('[data-id="'+t+'"]').querySelector("[data-"+e+"]"));"wait"===a?n.addClass("actions__button--wait"):"done"===a?n.removeClass("actions__button--wait"):"active"===a?n.addClass("actions__button--active"):"inactive"===a&&n.removeClass("actions__button--active")},this.isActionActive=function(e,t){var a=angular.element(document.querySelector('[data-id="'+t+'"]').querySelector("[data-"+e+"]"));return a.hasClass("actions__button--active")},this.isActionWait=function(e,t){var a=angular.element(document.querySelector('[data-id="'+t+'"]').querySelector("[data-"+e+"]"));return a.hasClass("actions__button--wait")}});
angular.module("Oneline.actionsServices",[]).service("olActionsHelper",["Action",function(e){this.toggleLike=function(i,n,o){var r=o?"destroy":"create";return e[r]({action:"like",provider:i,id:n})}}]);
angular.module("Oneline.relativeDateServices",["relativeDate"]).value("relativeDateTranslations",{just_now:"0s",seconds_ago:"{{time}}s",a_minute_ago:"1m",minutes_ago:"{{time}}m",an_hour_ago:"1h",hours_ago:"{{time}}h",a_day_ago:"1d",days_ago:"{{time}}d",a_week_ago:"1w",weeks_ago:"{{time}}w",a_month_ago:"1M",months_ago:"{{time}}M",a_year_ago:"1y",years_ago:"{{time}}y",over_a_year_ago:"> 1y",seconds_from_now:"+ {{time}}s",a_minute_from_now:"+ 1m",minutes_from_now:"+ {{time}}m",an_hour_from_now:"+ 1h",hours_from_now:"+ {{time}}h",a_day_from_now:"+ 1d",days_from_now:"+ {{time}}d",a_week_from_now:"+ 1w",weeks_from_now:"+ {{time}}w",a_month_from_now:"+ 1M",months_from_now:"+ {{time}}M",a_year_from_now:"+ 1y",years_from_now:"+ {{time}}y",over_a_year_from_now:"++ 1y"});
angular.module("Oneline.timelineServices",[]).service("olTimelineHelper",["$q","Timeline","timelineCache","olUI",function(t,e,n,o){var i=Date.now(),s=50,r=18e5;this.getId=function(t,e){var o,i,s=(n.get(t),"");return"oldPosts"===t?(o="_maxId-",i="_min_id"):(o="_minId-",i="_max_id"),e.forEach(function(t,r){var a=(n.get("oldPosts"),t+o+n.get(t+i)+(r===e.length-1?"":","));s+=a}),s},this.storePosts=function(t,e,o){var i,s,r,a=n.get(t)||[];"oldPosts"===t?(i="min",s="_min_id",r="_min_date"):(i="max",s="_max_id",r="_max_date"),o.forEach(function(t){var o=t+s,a=e[i+"_id"][t],l=t+r,d=e[i+"_date"][t];a&&n.put(o,a),d&&n.put(l,d)}),a=a.concat(e.data),n.put(t,a)},this.checkOldPosts=function(e){return t(function(t,o){var s=e.filter(function(t){return i-n.get(t+"_min_date")<r});s.length>0?t(s):o("all valid")})},this.extractOldPosts=function(){for(var t,e=n.get("oldPosts")||[],o=[],s=!0;s;)t=e.filter(function(t){var e=i-t.created_at<=r;return e||o.push(t),e}),i-=r,n.put("oldPosts",o),o=[],t.length>0&&(s=!1);return t},this.loadOldPosts=function(n,i){function r(n){var s=t.defer(),r=d.getId("oldPosts",n);return e.load({id:r,count:u}).$promise.then(function(t){t.min_date.twitter&&t.data.splice(0,1),d.storePosts("oldPosts",t,i),100>u?u+=10:null,s.resolve()},function(t){404===t.status&&o.setLoading(!1,-1)}),s.promise}function a(){var e=t.defer();return d.checkOldPosts(i).then(function(t){r(t).then(a).then(function(){e.resolve()})},function(){e.resolve()}),e.promise}var l=t.defer(),d=this,u=s;return r(n).then(a).then(function(){100>s?s+=10:null,l.resolve()}),l.promise},this.loadNewPosts=function(n){var o=t.defer();return _this=this,e.load({id:_this.getId("newPosts",n),count:20}).$promise.then(function(t){t.data.length>0&&(_this.storePosts("newPosts",t,n),o.resolve())}),o.promise}}]);
angular.module("Oneline.tokenHelperServices",[]).service("olTokenHelper",["jwtHelper","store",function(e,n){this.addToken=function(){var o=localStorage.getItem("addToken"),r=e.decodeToken(o).provider,i=n.get("tokenList")||[];i=t.removeToken(i,r),i.push(o),n.set("tokenList",i),n.remove("addToken")},this.removeToken=function(e){var o=n.get("tokenList")||[];o=t.removeToken(o,e),n.set("tokenList",o)},this.clearToken=function(){n.remove("tokenList")},this.getProviderList=function(){var t=n.get("tokenList")||[];return t.map(function(n){return e.decodeToken(n).provider})},this.isValidToken=function(){var t=n.get("tokenList")||[];return t.length>0&&t.every(function(n){return!e.isTokenExpired(n)})};var t={removeToken:function(n,t){return n.filter(function(n){return t!==e.decodeToken(n).provider})}}}]);
angular.module("Oneline.rootControllers",[]).controller("rootController",["$scope","$timeout","store","olTokenHelper",function(e,i,r,o){e.providerList=o.getProviderList(),e.isTimeline=!1,e.timelineProvider=r.get("timelineProvider")||"all",r.set("timelineProvider",e.timelineProvider),e.updateProviderList=function(){i(function(){e.providerList=o.getProviderList()})},e.setTimeline=function(i){e.isTimeline=i},e.isAuth=function(i){return e.providerList.indexOf(i)>=0}}]);
angular.module("Oneline.settingsControllers",[]).controller("settingsCtrl",["$scope","$window","$state","$stateParams","store","olTokenHelper","timelineCache","Auth",function(e,t,o,i,n,r,l,d){r.isValidToken()?"1"!==i.s&&o.go("timeline",{provider:n.get("timelineProvider")}):(r.clearToken(),e.updateProviderList()),e.setTimeline(!1),t.addEventListener("storage",function(t){"addToken"===t.key&&(r.addToken(),e.updateProviderList())}),e.toggleAuth=function(o){e.providerList.indexOf(o)<0?t.open("/auth/"+o,"_blank"):d.revoke({provider:o}).$promise["finally"](function(){r.removeToken(o),e.updateProviderList(),l.removeAll()})}}]);
angular.module("Oneline.timelineControllers",[]).controller("timelineCtrl",["$scope","$interval","$state","$stateParams","store","Timeline","olUI","olTokenHelper","olTimelineHelper","olActionsHelper","timelineCache",function(t,e,i,n,o,s,a,l,r,c,d){function u(t){o.set("timelineProvider",t),i.go("timeline",{provider:t})}l.isValidToken()||(l.clearToken(),t.updateProviderList(),i.go("settings")),t.setTimeline(!0),t.providerList.indexOf(n.provider)>=0||"all"===n.provider?u(n.provider):i.go("timeline",{provider:o.get("timelineProvider")}),t.timelineData=[],s.initLoad().$promise.then(function(e){r.storePosts("oldPosts",e,t.providerList);var i={data:[],max_id:e.max_id,max_date:e.max_date};r.storePosts("newPosts",i,t.providerList),t.timelineData=r.extractOldPosts(),a.setLoading(!1,1),a.setLoading(!1,-1)},function(t){401===t.status&&i.go("settings")}),t.loadMore=function(e){if(!a.isLoading(e))if(a.setLoading(!0,e),e>0){var n=d.get("newPosts")||[];if(n.length>0)return a.setDivider(e),t.timelineData=t.timelineData.concat(n),d.put("newPosts",[]),void a.setLoading(!1,e);s.load({id:r.getId("newPosts",t.providerList),count:70}).$promise.then(function(i){i.data.length>0&&(a.setDivider(e),t.timelineData=t.timelineData.concat(i.data))})["catch"](function(t){401===t.status&&i.go("settings")})["finally"](function(){a.setLoading(!1,e)})}else r.checkOldPosts(t.providerList).then(function(e){return r.loadOldPosts(e,t.providerList)},function(){})["catch"](function(t){console.log(t)})["finally"](function(){a.setDivider(e),a.setLoading(!1,e),t.timelineData=t.timelineData.concat(r.extractOldPosts())})},t.resetCount=function(){a.setNewPostsCount("")},e(function(){r.loadNewPosts(t.providerList).then(function(){var t=(d.get("newPosts")||[]).length;a.setNewPostsCount(t)},function(){})},18e4),t.toggleLike=function(t,e){if(!a.isActionWait("like",e)){var i=a.isActionActive("like",e),n=i?"inactive":"active";a.setActionState("like",e,"wait"),a.setActionState("like",e,n),c.toggleLike(t,e,i).$promise["catch"](function(t){a.setActionState("like",e,!n)})["finally"](function(){a.setActionState("like",e,"done")})}}}]);
//# sourceMappingURL=oneline.min.js.map